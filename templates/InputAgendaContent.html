<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"> <!--防止移动端缩放-->
        <title></title>

        <style type="text/css">

            .loading {
                width: 250px;
                height: 56px;
                position: absolute;
                top: 50%;
                left: 50%;
                margin: -28px 0px 0px -125px;
                line-height: 56px;
                color: #fff;
                padding-left: 60px;
                font-size: 12px;
                background: #000 url(../static/imgs/waiting.gif) no-repeat 10px 50%;
                opacity: 0.7;
                z-index: 9999;
                -moz-border-radius: 20px;
                -webkit-border-radius: 20px;
                border-radius: 20px;
                filter: progid:DXImageTransform.Microsoft.Alpha(opacity=70);
            }
                </style>
                <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
            <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
                <!--jQuery cdn链接-->
                <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
              <script src="https://cdn.staticfile.org/popper.js/1.15.0/umd/popper.min.js"></script>
                <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
                <script src="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
        <!-- <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"> -->

    </head>

    <body>
        <!-- 提交数据后显示结果的模态框 -->
        <!-- data-bs-backdrop="static" data-bs-keyboard="false" -->
        <div class="modal fade" id="staticBackdrop"  tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="staticBackdropLabel">生成结果</h5>
                        <!-- <button type="button" id="staticBackdropClose" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
                      </div>
                      <div class="modal-body" id="Submitted_Content">
                        
                      </div>
                </div>
            
            </div>
        </div>

        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <fieldset style="text-align: center;">
                        <legend>议程表助手</legend>
                    </fieldset>
                </div>
                
            </div>
            <div class="row">
                <div class="col-12">
                    <form>
                        <div class="form-group">
                            <label for="meeting_info">会议信息</label>
                            <textarea id="meeting_info" class="form-control" name="meeting_info" rows="5" placeholder="请输入会议信息">{% for item in data['meeting_info'] %}
    {{ item['field_name'] }}: {{ item['content'] }}{% if not loop.last %} {% endif %}{% endfor %}</textarea>
                        </div>
    
                        <div class="form-group">
                            <label for="role_name_list">会议角色及人员</label>
                            <textarea id="role_name_list" class="form-control" name="role_name_list" rows="8" placeholder="请输入会议角色及对应人名">{% for item in data['role_name_list'] %}
    {{ item['role'] }}: {{ item['name'] }}{% if not loop.last %} {% endif %}{% endfor %}</textarea>
                        </div>
    
                        <div class="form-group">
                            <label for="">议程安排</label>
                            <textarea id="agenda_content" class="form-control" name="agenda_content" rows="18" placeholder=""># 会议开场
    主持人开场白(介绍会议主要内容、及可能的议程改动) 1 主持人
    介绍会议规则以及宾客介绍（限时每位30秒） 2 礼宾师
    介绍国际演讲会及捷普聚思国际演讲俱乐部 5 主席
    # 会议支持者介绍
    主持人介绍及中场串词 1 主持人
    时间官 1 时间官
    哼哈师 1 哼哈师
    语法师&词汇大师（今日之词：） 2 语法师
    总体点评师 1 总体点评师
    破冰师 6 破冰师
    # 即兴演讲
    主持人串词 1 主持人
    即兴主持人 2 即兴主持人
    即兴演讲《诗和远方》（演讲每人2分钟，邀请串场1分钟） 18 会员&宾客
    主持人串词 1 主持人
    即兴点评报告 7 即兴点评师
    # 小歇及合影 5
    # 备稿演讲及点评
    主持人串词 1 主持人
    点评师介绍项目级别和要求 1 备稿点评师1
    备稿演讲1《人工智能，我们该何去何从》 7 备稿演讲者1
    点评师介绍项目级别和要求 1 备稿点评师2
    备稿演讲2《蜕变》MS5-1 12 备稿演讲者2
    主持人串词 1 主持人
    备稿点评1 3 备稿点评师1
    主持人串词 1 主持人
    备稿点评2 3 备稿点评师2
    # 会议支持者报告
    主持人开场及中场串词 1 主持人
    时间官报告 2 时间官
    哼哈师报告 2 哼哈师
    语法师报告 3 语法师
    总体点评师报告 7 总体点评师
    # 主持人提示观众投票选出“最佳备稿演讲”等，微信小程序投票
    # 会议尾声
    嘉宾回访环节 2 主席
    颁奖 2 主席
    会议招募 1 下一期会议经理
    # 会议结束</textarea>
                            
                        </div>
    
                        <div class="form-group">
                            <div id="message"></div>
                            <div class="row mb-1">
                                <div class="col">
                                    <button type="button" id="submitButton" class="btn btn-primary btn-lg btn-block">生成议程表</button>
                                </div>
                            </div>
                            <div class="row mb-1">
                                <div class="col">
                                    <button type="button" id="previewImage" class="btn btn-success btn-lg btn-block">预览图片</button>
                                </div>
                                <div class="col">
                                    <button type="button" id="downloadImage" class="btn btn-success btn-lg btn-block">导出图片</button>
                                </div>
                            </div>
                            <div class="row mb-1">
                                <div class="col">
                                    <button type="button" id="previewPdf" class="btn btn-success btn-lg btn-block">预览PDF</button>
                                </div>
                                <div class="col">
                                    <button type="button" id="downloadPdf" class="btn btn-success btn-lg btn-block">导出PDF</button>
                                </div>
                            </div>
                            <div class="row mb-1">
                                <div class="col">
                                    <button type="button" id="downloadExcel" class="btn btn-info btn-lg btn-block">下载Excel表格</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
            </div>
        </div>
        
        <script>
              var HasSubmittedMessage = false;

            $(document).ready(function() {
              // Event listener for the submit button click
              $('#submitButton').click(function() {
                // var myModal = document.getElementById('myModal')
                // var myInput = document.getElementById('myInput')

                // myModal.addEventListener('shown.bs.modal', function () {
                //     myInput.focus()
                // })
                MaskUtil.mask();
                // Create an object to store the form data
                var formData = {
                  meeting_info: $('#meeting_info').val(),
                  role_name_list: $('#role_name_list').val(),
                  agenda_content: $('#agenda_content').val()
                };
            
                // Send the form data as JSON via a POST request
                $.ajax({
                  type: 'POST',
                  url: './generate_with_text_blocks',
                  data: JSON.stringify(formData),
                  contentType: 'application/json',
                  success: function(response) {
                    // Handle the response from the server
                    console.log('Data sent successfully');
                    console.log(response);

                    //Shutdown shade
                    MaskUtil.unmask();

                    // Pop a message to notify the user.
                    $('#Submitted_Content').empty();
                    $('#Submitted_Content').append('<div class="alert alert-success" role="alert"> 议程表生成成功 </div>');
                    $('#staticBackdrop').modal('show');

                    // Close modal automatically
                    window.setTimeout(function(){
                        // $("#staticBackdropClose").trigger("click");
                        $("#staticBackdrop").modal('hide');
                    },1500);

                    HasSubmittedMessage = true;
                  },
                  error: function(error) {
                    // Handle any errors that occur during the request
                    console.error('Error:', error);
                    // Display an error message to the user
                    // $('#message').html('<p>Error occurred: ' + error.statusText + '</p>');

                    MaskUtil.unmask();
                    $('#Submitted_Content').empty();
                    $('#Submitted_Content').append('<div class="alert alert-danger" role="alert"> '+ error.statusText +' </div>');
                    $('#staticBackdrop').modal('show');

                    window.setTimeout(function(){
                        $("#staticBackdrop").modal('hide');
                    },1500);
                  }
                });
              });
            });

            // Add JavaScript code to send a request to the Flask route when the button is clicked
            document.getElementById("downloadExcel").addEventListener("click", function() {
                if(HasSubmittedMessage == false){
                    $('#Submitted_Content').empty();
                    $('#Submitted_Content').append('<div class="alert alert-danger" role="alert">请先要生成议程表</div>');
                    $('#staticBackdrop').modal('show');

                    window.setTimeout(function(){
                    // $("#staticBackdropClose").trigger("click");
                        $("#staticBackdrop").modal('hide');
                    },1500);
                    return;
                }

                MaskUtil.mask();

            // Send a GET request to the '/export_image' route
            fetch('./download_excel', {
                method: 'GET'
            })
            .then(response => {
                if (response.ok) {
                    // If the response is successful, trigger the download
                    response.blob().then(blob => {
                        var url = window.URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = 'touma_club_agenda.xlsx'; // You can set the desired filename here
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);

                        MaskUtil.unmask();
                        $('#Submitted_Content').empty();
                        $('#Submitted_Content').append('<div class="alert alert-success" role="alert">下载Excel版议程表成功</div>');
                        $('#staticBackdrop').modal('show');

                        window.setTimeout(function(){
                        // $("#staticBackdropClose").trigger("click");
                            $("#staticBackdrop").modal('hide');
                        },1500);
                    });
                } else {
                    console.error("Failed to download EXCEL");
                    
                    MaskUtil.unmask();
                    $('#Submitted_Content').empty();
                    $('#Submitted_Content').append('<div class="alert alert-danger" role="alert">下载Excel版议程表失败</div>');
                    $('#staticBackdrop').modal('show');

                    window.setTimeout(function(){
                        // $("#staticBackdropClose").trigger("click");
                        $("#staticBackdrop").modal('hide');
                    },1500);
                }
            })
            .catch(error => {
                console.error("Error:", error);

                MaskUtil.unmask();
                    $('#Submitted_Content').empty();
                    $('#Submitted_Content').append('<div class="alert alert-danger" role="alert">下载Excel版议程表失败</div>');
                    $('#staticBackdrop').modal('show');

                    window.setTimeout(function(){
                        // $("#staticBackdropClose").trigger("click");
                        $("#staticBackdrop").modal('hide');
                    },1500);
            });
        });

        document.getElementById("downloadPdf").addEventListener("click", function() {
            if(HasSubmittedMessage == false){
                    $('#Submitted_Content').empty();
                    $('#Submitted_Content').append('<div class="alert alert-danger" role="alert">请先点击生成议程表</div>');
                    $('#staticBackdrop').modal('show');

                    window.setTimeout(function(){
                    // $("#staticBackdropClose").trigger("click");
                        $("#staticBackdrop").modal('hide');
                    },1500);
                    return;
                }

            MaskUtil.mask();

            // Send a GET request to the server to download the PDF
            fetch('./download_pdf', {
                method: 'GET'
            })
            .then(response => {
                if (response.ok) {
                    // If the response is successful, trigger the download
                    response.blob().then(blob => {
                        var url = window.URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = 'touma_club_agenda.pdf'; // You can set the desired filename here
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);

                        MaskUtil.unmask();
                        $('#Submitted_Content').empty();
                        $('#Submitted_Content').append('<div class="alert alert-success" role="alert">下载PDF版议程表成功</div>');
                        $('#staticBackdrop').modal('show');

                        window.setTimeout(function(){
                            // $("#staticBackdropClose").trigger("click");
                            $("#staticBackdrop").modal('hide');
                        },1500);
                    });
                } else {
                    console.error("Failed to download PDF");

                    MaskUtil.unmask();
                    $('#Submitted_Content').empty();
                    $('#Submitted_Content').append('<div class="alert alert-danger" role="alert">下载PDF版议程表失败</div>');
                    $('#staticBackdrop').modal('show');

                    window.setTimeout(function(){
                        // $("#staticBackdropClose").trigger("click");
                        $("#staticBackdrop").modal('hide');
                    },1500);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                MaskUtil.unmask();
                    $('#Submitted_Content').empty();
                    $('#Submitted_Content').append('<div class="alert alert-danger" role="alert">下载PDF版议程表失败</div>');
                    $('#staticBackdrop').modal('show');

                    window.setTimeout(function(){
                        // $("#staticBackdropClose").trigger("click");
                        $("#staticBackdrop").modal('hide');
                    },1500);
            });
        });

        document.getElementById("previewPdf").addEventListener("click", function() {
            if(HasSubmittedMessage == false){
                    $('#Submitted_Content').empty();
                    $('#Submitted_Content').append('<div class="alert alert-danger" role="alert">请先点击生成议程表</div>');
                    $('#staticBackdrop').modal('show');

                    window.setTimeout(function(){
                    // $("#staticBackdropClose").trigger("click");
                        $("#staticBackdrop").modal('hide');
                    },1500);
                    return;
                }

            MaskUtil.mask();

            fetch('./download_pdf', {
                method: 'GET'
            })
            .then(response => {
                if (response.ok) {
                    // If the response is successful, display the PDF in a new browser tab
                    response.blob().then(blob => {
                        var url = window.URL.createObjectURL(blob);

                        // Open the PDF in a new browser tab
                        window.open(url, '_blank');

                        MaskUtil.unmask();
                        $('#Submitted_Content').empty();
                        $('#Submitted_Content').append('<div class="alert alert-success" role="alert">预览PDF版议程表成功</div>');
                        $('#staticBackdrop').modal('show');

                        window.setTimeout(function(){
                            // $("#staticBackdropClose").trigger("click");
                            $("#staticBackdrop").modal('hide');
                        },1500);
                    });
                } else {
                    console.error("Failed to retrieve PDF");

                    MaskUtil.unmask();
                    $('#Submitted_Content').empty();
                    $('#Submitted_Content').append('<div class="alert alert-danger" role="alert">预览PDF版议程表失败</div>');
                    $('#staticBackdrop').modal('show');

                    window.setTimeout(function(){
                        // $("#staticBackdropClose").trigger("click");
                        $("#staticBackdrop").modal('hide');
                    },1500);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                MaskUtil.unmask();
                $('#Submitted_Content').empty();
                $('#Submitted_Content').append('<div class="alert alert-danger" role="alert">预览PDF版议程表失败</div>');
                $('#staticBackdrop').modal('show');

                window.setTimeout(function(){
                    // $("#staticBackdropClose").trigger("click");
                    $("#staticBackdrop").modal('hide');
                },1500);
            });
        });


        document.getElementById("downloadImage").addEventListener("click", function() {
            if(HasSubmittedMessage == false){
                    $('#Submitted_Content').empty();
                    $('#Submitted_Content').append('<div class="alert alert-danger" role="alert">请先点击生成议程表</div>');
                    $('#staticBackdrop').modal('show');

                    window.setTimeout(function(){
                    // $("#staticBackdropClose").trigger("click");
                        $("#staticBackdrop").modal('hide');
                    },1500);
                    return;
                }

            MaskUtil.mask();

            // Send a GET request to the server to download the PDF
            fetch('./export_image', {
                method: 'GET'
            })
            .then(response => {
                if (response.ok) {
                    // If the response is successful, trigger the download
                    response.blob().then(blob => {
                        var url = window.URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = 'touma_club_agenda.jpg'; // You can set the desired filename here
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);

                        MaskUtil.unmask();
                        $('#Submitted_Content').empty();
                        $('#Submitted_Content').append('<div class="alert alert-success" role="alert">下载图片议程表成功</div>');
                        $('#staticBackdrop').modal('show');

                        window.setTimeout(function(){
                            $("#staticBackdrop").modal('hide');
                        },1500);
                    });
                } else {
                    console.error("Failed to download image");

                    MaskUtil.unmask();
                    $('#Submitted_Content').empty();
                    $('#Submitted_Content').append('<div class="alert alert-danger" role="alert">下载图片议程表失败</div>');
                    $('#staticBackdrop').modal('show');

                    window.setTimeout(function(){
                        $("#staticBackdrop").modal('hide');
                    },1500);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                MaskUtil.unmask();
                    $('#Submitted_Content').empty();
                    $('#Submitted_Content').append('<div class="alert alert-danger" role="alert">下载图片议程表失败</div>');
                    $('#staticBackdrop').modal('show');

                    window.setTimeout(function(){
                        $("#staticBackdrop").modal('hide');
                    },1500);
            });
        });

        document.getElementById("previewImage").addEventListener("click", function() {
            if(HasSubmittedMessage == false){
                    $('#Submitted_Content').empty();
                    $('#Submitted_Content').append('<div class="alert alert-danger" role="alert">请先点击生成议程表</div>');
                    $('#staticBackdrop').modal('show');

                    window.setTimeout(function(){
                    // $("#staticBackdropClose").trigger("click");
                        $("#staticBackdrop").modal('hide');
                    },1500);
                    return;
                }

            MaskUtil.mask();

            fetch('./export_image', {
                method: 'GET'
            })
            .then(response => {
                if (response.ok) {
                    // If the response is successful, display the PDF in a new browser tab
                    response.blob().then(blob => {
                        var url = window.URL.createObjectURL(blob);

                        // Open the PDF in a new browser tab
                        window.open(url, '_blank');

                        MaskUtil.unmask();
                        $('#Submitted_Content').empty();
                        $('#Submitted_Content').append('<div class="alert alert-success" role="alert">预览图片议程表成功</div>');
                        $('#staticBackdrop').modal('show');

                        window.setTimeout(function(){
                            // $("#staticBackdropClose").trigger("click");
                            $("#staticBackdrop").modal('hide');
                        },1500);
                    });
                } else {
                    console.error("Failed to preview image");

                    MaskUtil.unmask();
                    $('#Submitted_Content').empty();
                    $('#Submitted_Content').append('<div class="alert alert-danger" role="alert">预览图片议程表失败</div>');
                    $('#staticBackdrop').modal('show');

                    window.setTimeout(function(){
                        // $("#staticBackdropClose").trigger("click");
                        $("#staticBackdrop").modal('hide');
                    },1500);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                MaskUtil.unmask();
                $('#Submitted_Content').empty();
                $('#Submitted_Content').append('<div class="alert alert-danger" role="alert">预览图片议程表失败</div>');
                $('#staticBackdrop').modal('show');

                window.setTimeout(function(){
                    // $("#staticBackdropClose").trigger("click");
                    $("#staticBackdrop").modal('hide');
                },1500);
            });
        });

        /**
 * 说明：数据进行加载时的遮罩层，基于bootstrap的页面模态框做封装处理
 * 使用方法:
 * 开启:MaskUtil.mask();
 * 关闭:MaskUtil.unmask();
 */
var MaskUtil = (function(){
    var $mask,$maskMsg;
    var defMsg = '正在生成，请稍等 . . .';
    function init(){
        if(!$mask){
            $mask = $("<div id=\"myWaitingModal\" class=\"modal fade\" data-keyboard=\"false\" data-backdrop=\"static\" data-role=\"dialog\" " +
                "aria-labelledby=\"myWaitingModalLabel\" aria-hidden=\"true\">" +
                "<div id=\"loading\" class=\"loading\"><span class=\"spinner-border\" role=\"status\"></span>"+
                    "<span>&nbsp;&nbsp;"+defMsg+"</span></div></div>").appendTo("body");
        }
    }
    return {
        mask:function(){
            init();
            $('#myWaitingModal').modal('show');
        }
        ,unmask:function(){
            $('#myWaitingModal').modal('hide');
            $mask = null;
            $('#myWaitingModal').remove();
            $('.modal-backdrop').hide();
        }
    }
}());
            </script>
    </body>

</html>